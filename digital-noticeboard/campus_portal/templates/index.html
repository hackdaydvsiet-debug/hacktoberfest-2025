{% extends "base.html" %}
{% block content %}
  <!-- Rotating Header Section -->
  <section class="relative mb-10 h-64 md:h-80 overflow-hidden rounded-lg shadow">
    <div id="headerImages" class="absolute inset-0 transition-opacity duration-1000">
      <img src="https://media.istockphoto.com/id/1001349692/photo/lost-and-found-sign.webp?a=1&b=1&s=612x612&w=0&k=20&c=5d7njz5W_kusB4fdP6SFkkP_EU0vGuzay1NUEyW4zJA=" class="absolute inset-0 w-full h-full object-cover opacity-100 transition-opacity duration-1000" />
      <img src="https://images.unsplash.com/photo-1626010448982-0fec79ed1979?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bG9zdCUyMGFuZCUyMGZvdW5kfGVufDB8fDB8fHww&auto=format&fit=crop&q=60&w=800" class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-1000" />
      <img src="https://images.unsplash.com/photo-1696242808540-b3d95609a59c?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGxvc3QlMjBhbmQlMjBmb3VuZHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&q=60&w=800" class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-1000" />
    </div>
    <div class="absolute inset-0 bg-black/40 flex flex-col justify-center items-center text-center text-white p-6 rounded-lg">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">Resource Exchange Platform</h1>
      <p class="max-w-2xl text-lg text-slate-100">
        Share and explore notes, projects, study materials, and more — all in one place.
      </p>
    </div>
  </section>

  <!-- Search Section -->
  <div class="mb-4 flex gap-2">
    <input id="q" class="flex-1 rounded border p-2" placeholder="Search by title or description">
    <button id="searchBtn" class="bg-sky-600 text-white px-4 rounded">Search</button>
  </div>

  <!-- Items Section -->
  <div id="sections" class="space-y-8"></div>

  <script>
    // Image rotation logic
    const headerImages = document.querySelectorAll('#headerImages img');
    let current = 0;
    setInterval(() => {
      headerImages[current].classList.remove('opacity-100');
      headerImages[current].classList.add('opacity-0');
      current = (current + 1) % headerImages.length;
      headerImages[current].classList.remove('opacity-0');
      headerImages[current].classList.add('opacity-100');
    }, 4000); // change every 4 seconds

    // Load items logic
    async function loadItems(q){
      let res = await fetch('/items');
      let items = await res.json();
      if(q){
        items = items.filter(it => (it.title + ' ' + (it.description||'')).toLowerCase().includes(q.toLowerCase()));
      }
      const grouped = {};
      for(const it of items){
        const kind = it.kind || 'Other';
        if(!grouped[kind]) grouped[kind] = [];
        grouped[kind].push(it);
      }
      const sectionsContainer = document.getElementById('sections');
      sectionsContainer.innerHTML = Object.keys(grouped).map(kind => {
        const kindItems = grouped[kind].map(it => {
          const images = it.image ? [it.image] : [];
          const imageHTML = images.map(img => `<img src="/${img}" class="mt-2 rounded w-full object-cover max-h-64" />`).join('');
          return `
            <div class="bg-white p-4 rounded shadow hover:shadow-lg transition">
              <h3 class="font-semibold text-lg mb-1">${it.title}</h3>
              <p class="text-sm text-slate-500 mb-2">${it.kind}</p>
              ${imageHTML}
              <p class="mt-2 text-slate-700">${it.description || ''}</p>
              <p class="mt-2 text-sm text-slate-600">Contact: ${it.contact || '—'}</p>
              <div class="mt-3 flex gap-3">
                {% raw %}
                <button onclick="deleteItem(${it.id})" class="text-red-600 hover:underline">Delete</button>
                {% endraw %}
              </div>
            </div>`;
        }).join('');
        return `
          <section>
            <h2 class="text-xl font-bold text-sky-700 mb-4 border-b pb-2">${kind}</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
              ${kindItems}
            </div>
          </section>`;
      }).join('') || '<p class="text-slate-600">No items yet.</p>';
    }

    document.getElementById('searchBtn').addEventListener('click', ()=> loadItems(document.getElementById('q').value));

    window.deleteItem = async function(id){
      if(!confirm('Delete item?')) return;
      const res = await fetch('/delete/' + id, {method:'POST'});
      if(res.ok) loadItems();
      else {
        const data = await res.json();
        alert(data.error || 'Delete failed');
      }
    }

    loadItems();
  </script>
{% endblock %}
